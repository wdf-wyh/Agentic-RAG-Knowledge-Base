# 智能意图路由系统

## 概述

智能意图路由系统让大模型（如 DeepSeek）**先分析用户的问题**，然后决定使用什么工具来回答：

```
用户问题 → 大模型意图分析 → 选择最佳处理方式 → 执行并返回结果
```

这种方式比简单的关键词匹配更准确，因为准确性取决于大模型的理解能力。
## 两种模式

系统现在只保留两种简洁的模式：

| 模式 | 说明 | 适用场景 |
|------|------|----------|
| 📚 **纯 RAG** | 仅知识库检索，速度快 | 明确只需要查询知识库时 |
| 🧠 **智能模式** | 大模型分析问题，自动选择最佳工具 | 默认推荐，适合所有场景 |
## 工作流程

```
┌──────────────────────────────────────────────────────────────┐
│                      用户提问                                  │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────┐
│               🧠 大模型意图分析 (IntentRouter)                  │
│                                                              │
│  分析问题类型、提取关键词、判断是否需要实时信息                    │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────┐
│                      意图类型判断                              │
│                                                              │
│  ├─ knowledge_base: 知识库查询（专业知识、概念解释）             │
│  ├─ web_search: 联网搜索（天气、新闻、实时信息）                 │
│  ├─ direct_answer: 直接回答（常识、计算、代码）                  │
│  ├─ conversation: 历史对话（"刚才问的是什么"）                   │
│  ├─ file_operation: 文件操作（读取、创建、修改文件）              │
│  ├─ trending: 热搜查询（热点、趋势）                            │
│  └─ multi_step: 复杂多步骤任务                                 │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────┐
│                      执行对应处理                              │
│                                                              │
│  • knowledge_base → 直接调用 RAG 检索                         │
│  • web_search → 使用 Agent + web_search 工具                  │
│  • direct_answer → 大模型直接回答，不调用任何工具                 │
│  • conversation → 从历史对话中提取答案                          │
│  • file_operation → 使用 Agent + 文件操作工具                   │
│  • trending → 使用热搜工具                                     │
│  • multi_step → 完整 Agent ReAct 推理                         │
└──────────────────────────────────────────────────────────────┘
```

## 意图类型详解

### 1. `knowledge_base` - 知识库查询
**触发条件**: 问题是关于专业概念、技术知识、文档内容

**示例**:
- "什么是 RAG？"
- "Python 的装饰器怎么用？"
- "解释一下向量数据库的原理"

**处理方式**: 直接调用 `rag_search` 工具

### 2. `web_search` - 联网搜索
**触发条件**: 问题涉及实时信息（天气、新闻、股价、最新事件等）

**示例**:
- "今天北京天气怎么样？"
- "最新的 AI 新闻有哪些？"
- "特斯拉现在股价多少？"

**处理方式**: 使用 Agent + `web_search` 工具

### 3. `direct_answer` - 直接回答
**触发条件**: 问题是常识、简单计算、代码编写等

**示例**:
- "1+1等于多少？"
- "写一个 Python 快速排序"
- "地球绕太阳一圈需要多久？"

**处理方式**: 大模型直接回答，不调用任何工具

### 4. `conversation` - 历史对话
**触发条件**: 问题涉及之前的对话

**示例**:
- "刚才我问了什么？"
- "上一个问题的答案是什么？"
- "你之前说的那个方法"

**处理方式**: 从历史对话中提取答案

### 5. `file_operation` - 文件操作
**触发条件**: 需要读取、创建、修改、移动文件

**示例**:
- "读取 readme.md 的内容"
- "创建一个新的配置文件"
- "把这个文件移动到 documents 文件夹"

**处理方式**: 使用 Agent + 文件操作工具

### 6. `trending` - 热搜查询
**触发条件**: 想了解热搜、热门话题、趋势

**示例**:
- "今天的百度热搜是什么？"
- "最近有什么热点新闻？"
- "微博热搜第一是什么？"

**处理方式**: 使用热搜工具（`baidu_trending` 等）

### 7. `multi_step` - 复杂多步骤任务
**触发条件**: 需要多步骤完成的复杂任务

**示例**:
- "分析知识库并生成优化报告"
- "搜索相关论文并总结要点"
- "整理文档目录结构"

**处理方式**: 完整 Agent ReAct 推理

## 代码结构

```
src/agent/
├── intent_router.py    # 智能意图路由器
├── rag_agent.py        # RAG Agent（已集成意图路由）
├── base.py             # Agent 基类
└── tools/              # 工具集
```

## 使用示例

```python
from src.agent import RAGAgent, AgentConfig

# 创建 Agent
agent = RAGAgent(
    config=AgentConfig(verbose=True),
    enable_web_search=True,
    enable_file_ops=True
)

# 开始对话
agent.start_conversation()

# 智能查询 - 会自动分析意图并选择最佳处理方式
result = agent.smart_query("今天北京天气怎么样？")
# 输出:
# 🧠 意图分析结果:
#    意图类型: web_search
#    置信度: 0.95
#    分析理由: 问题涉及天气这种实时信息，需要联网搜索
#    建议工具: ['web_search']

print(result.answer)
```

## 配置说明

意图路由器使用较低的温度（0.1）来获得更确定的分析结果：

```python
# 在 IntentRouter 中
self.llm = ChatDeepSeek(
    model=Config.LLM_MODEL,
    temperature=0.1,  # 低温度 = 更确定的分析
    api_key=Config.DEEPSEEK_API_KEY,
)
```

## 优势

1. **更准确的意图理解**: 大模型能理解语义，而不仅仅是关键词匹配
2. **灵活性**: 模型可以处理各种表达方式，不局限于固定模式
3. **可扩展性**: 可以轻松添加新的意图类型
4. **置信度**: 提供置信度分数，可以根据置信度决定处理策略
5. **推理过程透明**: 返回分析理由，便于调试和优化

## 注意事项

1. 意图分析会产生一次额外的 API 调用，增加少量延迟和成本
2. 分析准确度取决于使用的大模型能力
3. 对于简单问题，可以考虑设置置信度阈值来跳过某些处理步骤
